name: HA Bridge CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/home-smart-assistant/smart-assistant-ha-bridge

jobs:
  build:
    runs-on: [self-hosted, Linux, X64, builder-linux-11]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build image
        run: |
          docker build -f Dockerfile -t "${IMAGE_NAME}:main" -t "${IMAGE_NAME}:${{ github.sha }}" .

      - name: Push image
        run: |
          docker push "${IMAGE_NAME}:main"
          docker push "${IMAGE_NAME}:${{ github.sha }}"

  deploy:
    runs-on: [self-hosted, Linux, X64, deploy-linux]
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - name: Login to GHCR (retry)
        env:
          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          retry() {
            local attempts="$1"
            local delay_seconds="$2"
            shift 2
            local n=1
            until "$@"; do
              if [ "$n" -ge "$attempts" ]; then
                echo "Command failed after ${attempts} attempts: $*"
                return 1
              fi
              echo "Attempt ${n}/${attempts} failed: $*"
              sleep "$delay_seconds"
              n=$((n + 1))
            done
          }

          login_ghcr() {
            docker logout ghcr.io >/dev/null 2>&1 || true
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
          }

          retry 5 6 login_ghcr

      - name: Deploy service on self-hosted runner
        env:
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
          IMAGE_TAG: ${{ github.sha }}
          SERVICE_NAME: smart_assistant_ha_bridge
          SERVICE_TAG_KEY: BRIDGE_IMAGE_TAG
          HEALTH_PATH: /v1/tools/catalog
        run: |
          set -euo pipefail
          export DOCKER_CLIENT_TIMEOUT=180
          export COMPOSE_HTTP_TIMEOUT=180

          retry() {
            local attempts="$1"
            local delay_seconds="$2"
            shift 2
            local n=1
            until "$@"; do
              if [ "$n" -ge "$attempts" ]; then
                echo "Command failed after ${attempts} attempts: $*"
                return 1
              fi
              echo "Attempt ${n}/${attempts} failed: $*"
              sleep "$delay_seconds"
              n=$((n + 1))
            done
          }

          DEPLOY_PATH="${DEPLOY_PATH:-/opt/smart-assistant}"
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          retry 5 4 curl -fsSL https://raw.githubusercontent.com/home-smart-assistant/smart-assistant-gateway/main/deploy/prod/docker-compose.yml -o docker-compose.yml
          if [ ! -f .env ]; then
            retry 5 4 curl -fsSL https://raw.githubusercontent.com/home-smart-assistant/smart-assistant-gateway/main/deploy/prod/.env.example -o .env
            echo "Created $DEPLOY_PATH/.env from template. Fill required values and rerun."
            exit 1
          fi

          set_env() {
            key="$1"
            value="$2"
            if grep -q "^${key}=" .env; then
              sed -i "s#^${key}=.*#${key}=${value}#g" .env
            else
              echo "${key}=${value}" >> .env
            fi
          }
          set_env "$SERVICE_TAG_KEY" "$IMAGE_TAG"

          retry 6 8 docker compose pull "$SERVICE_NAME"
          retry 3 5 docker compose up -d --no-deps "$SERVICE_NAME"

          BRIDGE_PORT_VALUE="$(grep '^BRIDGE_PORT=' .env | tail -n 1 | cut -d'=' -f2)"
          if [ -z "${BRIDGE_PORT_VALUE}" ]; then
            BRIDGE_PORT_VALUE="8092"
          fi
          HEALTH_URL="http://127.0.0.1:${BRIDGE_PORT_VALUE}${HEALTH_PATH}"

          for i in $(seq 1 20); do
            if curl -fsS "$HEALTH_URL" >/dev/null; then
              echo "Health check passed: $HEALTH_URL"
              exit 0
            fi
            sleep 3
          done

          echo "Health check failed: $HEALTH_URL"
          docker compose logs --tail=200 "$SERVICE_NAME"
          exit 1
